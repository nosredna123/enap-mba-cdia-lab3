# Cache Architecture

## Two-File Design

The classification pipeline now uses an optimized two-file cache structure:

### 1. Classification Cache (`cache/classificacao_cache.json`)
**Purpose**: Lightweight mapping of solicitation text to assigned categories

**Structure**:
```json
{
  "solicitation_text_1": "Category Name 1",
  "solicitation_text_2": "Category Name 2",
  "solicitation_text_3": "Category Name 1"
}
```

**Characteristics**:
- Simple key→value mapping
- Very fast to read and write
- Minimal file size
- No redundancy

### 2. Category Registry (`cache/categorias.json`)
**Purpose**: Single source of truth for category definitions

**Structure**:
```json
{
  "Category Name 1": {
    "descricao": "Description of the category...",
    "exemplos": [
      "Example solicitation 1",
      "Example solicitation 2",
      "Example solicitation 3"
    ]
  },
  "Category Name 2": {
    "descricao": "Another category description...",
    "exemplos": [
      "Example text..."
    ]
  }
}
```

**Characteristics**:
- Category name is the JSON key (no redundancy)
- Each category stored exactly once
- Rich metadata (descriptions and examples)
- Updated when LLM proposes new categories
- Examples limited to 3 per category for prompt efficiency

## Persistence Strategy

Both files are persisted **immediately after each new classification**:

1. **Classification occurs** → LLM returns category
2. **Update classification cache** → Add text→category mapping
3. **Update category registry** → Merge category definitions and examples
4. **Save both files to disk** → Fail-fast on write errors
5. **Continue to next classification**

## Benefits Over Previous Design

| Aspect | Old Design | New Design |
|--------|------------|------------|
| **Storage** | ~10KB per classification | ~30 bytes per classification |
| **Redundancy** | Category list stored N times | Category list stored once |
| **Write Speed** | Slow (full category list) | Fast (minimal data) |
| **Maintainability** | Mixed concerns | Clear separation |
| **Analytics** | Hard to track categories | Easy to analyze independently |
| **Cache Hits** | Still efficient | Still efficient |

## Example File Sizes

For 100 classifications with 5 categories:
- **Old format**: ~100KB (1KB per entry × 100)
- **New format**: 
  - Classification cache: ~3KB (30 bytes × 100)
  - Category registry: ~1.5KB (300 bytes × 5, no redundant names)
  - **Total: ~4.5KB** (95.5% reduction!)

## Usage

The pipeline automatically manages both files. To start fresh:

```bash
rm -f cache/classificacao_cache.json cache/categorias.json
python process_relatorios.py
```

To inspect categories independently:

```bash
cat cache/categorias.json | jq
```

To check classification stats:

```bash
cat cache/classificacao_cache.json | jq 'length'
```
